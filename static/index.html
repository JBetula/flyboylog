<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <title>Flight Data</title>
</head>

<body>

    <div class="container mt-5">
        <h2>Flight Data</h2>
        Sectors
        <!-- Search bar and button -->
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="searchInput" placeholder="Search by Name">
            <div class="input-group-append">
                <button class="btn btn-primary" type="button" id="searchButton">Search</button>
            </div>
        </div>
        <!-- Display total hours row -->
        <div class="mb-3">
            <strong>Total Hours: </strong><span id="totalHours"></span><br>
            <strong>Sectors: </strong><span id="totalSectors"></span>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th>
                        Date
                        <span id="arrow" style="cursor:pointer;">â†•</span>
                    </th>
                    <th> Reg </th>
                    <th>Flight Number</th>
                    <th>Departure</th>
                    <th>OffBlock</th>
                    <th>Destination</th>
                    <th>BlocksOn</th>
                    <th>Blocktime</th>
                    <th>Commander</th>
                    <th>Flight Crew</th>
                </tr>
            </thead>
            <tbody id="flightDataBody">
                <!-- Data will be dynamically inserted here -->
            </tbody>
        </table>
    </div>

    <script>
        async function fetchData(searchTerm = '') {
            if (!searchTerm) return
            try {
                const response = await fetch(`http://localhost:3000/api/logbook?name=${encodeURIComponent(searchTerm)}`, {
                    method: 'GET'
                });
                const data = await response.json();
                const len = data.length
                populateTable(data);
                let sum = 0
                for (let index = 0; index < len; index++) {
                    sum = sum + data[index].blocktimeMinutes;
                }
                sum = Math.floor(sum / 60)
                document.getElementById('totalHours').textContent = sum;
                document.getElementById('totalSectors').textContent = len;
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
        // Function to make a GET request for total hours
        async function fetchTotalHours(searchTerm = '') {
            try {
                const response = await fetch(`http://localhost:3000/api/totalhours?name=${encodeURIComponent(searchTerm)}`);
                const totalHours = await response.json();
                console.log("totalhours=", totalHours)
                document.getElementById('totalHours').textContent = totalHours[0].totalTime;
                document.getElementById('totalSectors').textContent = totalHours[0].sectors;
            } catch (error) {
                console.error('Error fetching total hours:', error);
            }
        }
        // Function to handle search
        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value;
            fetchData(searchTerm)
        }

        // Function to populate the table with data
        function populateTable(data) {
            const tableBody = document.getElementById('flightDataBody');
            tableBody.innerHTML = ''; // Clear existing rows

            console.log(data);

            // Loop through the response data and create rows
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${item.date.split('T')[0]}</td>
                <td>${item.reg}</td>
                <td>${item.flightNumber}</td>
                <td>${item.depature}</td>
                <td>${item.offBlock.split('T')[1].split('.')[0]}</td>
                <td>${item.destination}</td>
                <td>${item.blocksOn.split('T')[1].split('.')[0]}</td>
                <td>${item.blocktime.split('T')[1].split('.')[0].split(':').slice(0, 2).join(':')}</td>
                <td>${item.cmd}</td>
                <td>${item.flightcrew.join(', ')}</td>
            `;
                tableBody.appendChild(row);
            });
        }

        // Attach an event listener to the search button
        document.getElementById('searchButton').addEventListener('click', handleSearch);

        // Attach an event listener to the Enter key in the search input
        document.getElementById('searchInput').addEventListener('keyup', function (event) {
            if (event.key === 'Enter') {
                handleSearch();
            }
        });
        let isAscending = true;

        document.getElementById('arrow').addEventListener('click', function () {
            sortTable(isAscending ? 'asc' : 'desc');
            isAscending = !isAscending; // Flip the sorting order for the next click
        });

        function sortTable(order) {
            let table, rows, switching, i, x, y, xOffblock, yOffblock, shouldSwitch;
            table = document.getElementById("flightDataBody");
            switching = true;

            while (switching) {
                switching = false;
                rows = table.rows;

                for (i = 0; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[0];
                    y = rows[i + 1].getElementsByTagName("TD")[0];
                    xOffblock = rows[i].getElementsByTagName("TD")[1]; // Get the offblock value for the current row
                    yOffblock = rows[i + 1].getElementsByTagName("TD")[1]; // Get the offblock value for the next row

                    if (x.innerHTML.toLowerCase() === y.innerHTML.toLowerCase()) {
                        // If the dates are equal, compare the offblock values
                        if (order === 'asc' ? xOffblock.innerHTML.toLowerCase() > yOffblock.innerHTML.toLowerCase() : xOffblock.innerHTML.toLowerCase() < yOffblock.innerHTML.toLowerCase()) {
                            shouldSwitch = true;
                            break;
                        }
                    } else if (order === 'asc' ? x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase() : x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                }

                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                }
            }
        }
    </script>

</body>

</html>