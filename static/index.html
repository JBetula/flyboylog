<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <title>Flight Data</title>
</head>

<body>

    <div class="container mt-5">
        <h2>Flight Data</h2>
        Sectors
        <!-- Search bar and button -->
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="searchInput" placeholder="Search by Name">
            <div class="input-group-append">
                <button class="btn btn-primary" type="button" id="searchButton">Search</button>
            </div>
        </div>
        <!-- Display total hours row -->
        <div class="mb-3">
            <strong>Total Hours: </strong><span id="totalHours"></span><br>
            <strong>Sectors: </strong><span id="totalSectors"></span>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th>
                        Date
                        <span id="arrow" style="cursor:pointer;">↕</span>
                    </th>
                    <th> Reg </th>
                    <th>Flight Number</th>
                    <th>Departure</th>
                    <th>OffBlock</th>
                    <th>Destination</th>
                    <th>BlocksOn</th>
                    <th>Blocktime</th>
                    <th>Commander
                        <span id="arrowCmd" style="cursor:pointer;">↕</span>
                    </th>
                    <th>Flight Crew</th>
                </tr>
            </thead>
            <tbody id="flightDataBody">
                <!-- Data will be dynamically inserted here -->
            </tbody>
        </table>
    </div>

    <script>
        var data = []
        async function fetchData(searchTerm = '') {
            if (!searchTerm) return
            try {
                const response = await fetch(`http://localhost:3000/api/logbook/logbook?name=${encodeURIComponent(searchTerm)}`, {
                    method: 'GET'
                });
                data = await response.json();
                const len = data.length
                populateTable(data);
                let sum = 0
                for (let index = 0; index < len; index++) {
                    sum = sum + data[index].blocktimeMinutes;
                }
                sum = Math.floor(sum / 60)
                document.getElementById('totalHours').textContent = sum;
                document.getElementById('totalSectors').textContent = len;
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
        
        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value;
            fetchData(searchTerm)
        }

        // Function to populate the table with data
        function populateTable(data) {
            const tableBody = document.getElementById('flightDataBody');
            tableBody.innerHTML = ''; // Clear existing rows

            console.log(data);

            // Loop through the response data and create rows
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${item.date.split('T')[0]}</td>
                <td>${item.reg}</td>
                <td>${item.flightNumber}</td>
                <td>${item.departure}</td>
                <td>${item.offBlock.split('T')[1].split('.')[0]}</td>
                <td>${item.destination}</td>
                <td>${item.blocksOn.split('T')[1].split('.')[0]}</td>
                <td>${item.blocktime.split('T')[1].split('.')[0].split(':').slice(0, 2).join(':')}</td>
                <td>${item.cmd}</td>
                <td>${item.flightcrew.join(', ')}</td>
            `;
                tableBody.appendChild(row);
            });
        }

        // Attach an event listener to the search button
        document.getElementById('searchButton').addEventListener('click', handleSearch);

        // Attach an event listener to the Enter key in the search input
        document.getElementById('searchInput').addEventListener('keyup', function (event) {
            if (event.key === 'Enter') {
                handleSearch();
            }
        });
        let isAscendingDate = false;
        let isAscendingCmd = false;

        document.getElementById('arrow').addEventListener('click', function () {
            sortTableDate(isAscendingDate ? 'asc' : 'desc');
            isAscendingDate = !isAscendingDate; // Flip the sorting order for the next click
        });
        document.getElementById('arrowCmd').addEventListener('click', function () {
            sortTableCmd(isAscendingCmd ? 'asc' : 'desc');
            isAscendingCmd = !isAscendingCmd; // Flip the sorting order for the next click
        });

        function sortTableCmd(order) {
            const tableBody = document.getElementById('flightDataBody');
            tableBody.innerHTML = ''; // Clear existing rows

            data.sort((a, b) => {
                const cmdComparison = a.cmd.localeCompare(b.cmd);
                if (cmdComparison !== 0) return order === 'asc' ? cmdComparison : -cmdComparison;

                // If cmd are equal, compare by date
                const dateComparison = new Date(a.date).getTime() - new Date(b.date).getTime();
                if (dateComparison !== 0) return dateComparison;

                // If dates are equal, compare by offBlock (always in ascending order)
                const offBlockComparison = new Date(a.offBlock).getTime() - new Date(b.offBlock).getTime();
                return offBlockComparison;
            });

            populateTable(data);
        }




        function sortTableDate(order) {
            const tableBody = document.getElementById('flightDataBody');
            tableBody.innerHTML = ''; // Clear existing rows

            data.sort((a, b) => {
                // Compare by date
                const dateComparison = new Date(a.date).getTime() - new Date(b.date).getTime();
                if (dateComparison !== 0) return order === 'asc' ? dateComparison : -dateComparison;

                // If dates are equal, compare by offBlock (always in ascending order)
                const offBlockComparison = new Date(a.offBlock).getTime() - new Date(b.offBlock).getTime();
                return offBlockComparison;
            });

            populateTable(data);
        }
    </script>

</body>

</html>